<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Interview HRD - PT. XYZ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <script src="https://cdn.webrtc-experiment.com/RecordRTC.js"></script>
  </head>
  <body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-4xl">
      <!-- Header -->
      <div class="bg-white rounded-2xl shadow-xl p-8 mb-6">
        <h1 class="text-4xl font-bold text-gray-800 mb-2">
          <i class="fas fa-briefcase text-indigo-600 mr-3"></i>
          Interview HRD PT. XYZ
        </h1>
        <p class="text-gray-600">
          Lengkapi data diri dan jawab pertanyaan wawancara
        </p>
      </div>

      <!-- Registration Form -->
      <div
        id="registration-form"
        class="bg-white rounded-2xl shadow-xl p-8 mb-6"
      >
        <h2 class="text-2xl font-bold text-gray-800 mb-6">
          <i class="fas fa-user-circle text-indigo-600 mr-2"></i>
          Data Kandidat
        </h2>

        <form id="candidate-form" class="space-y-5">
          <!-- Nama -->
          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-2">
              Nama Lengkap <span class="text-red-500">*</span>
            </label>
            <input
              type="text"
              id="candidate-name"
              required
              class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-indigo-500 focus:outline-none transition"
              placeholder="Masukkan nama lengkap Anda"
            />
          </div>

          <!-- Email -->
          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-2">
              Email <span class="text-red-500">*</span>
            </label>
            <input
              type="email"
              id="candidate-email"
              required
              class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-indigo-500 focus:outline-none transition"
              placeholder="contoh@email.com"
            />
          </div>

          <!-- Posisi -->
          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-2">
              Posisi yang Dilamar <span class="text-red-500">*</span>
            </label>
            <select
              id="candidate-position"
              required
              class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-indigo-500 focus:outline-none transition"
            >
              <option value="">-- Pilih Posisi --</option>
              <option value="Frontend Developer">Frontend Developer</option>
              <option value="Backend Developer">Backend Developer</option>
              <option value="Data Scientist">Data Scientist</option>
            </select>
          </div>

          <!-- CV Upload -->
          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-2">
              Upload CV (PDF) <span class="text-red-500">*</span>
            </label>
            <div class="relative">
              <input
                type="file"
                id="candidate-cv"
                accept=".pdf"
                required
                class="hidden"
              />
              <label
                for="candidate-cv"
                class="flex items-center justify-center w-full px-4 py-3 border-2 border-dashed border-gray-300 rounded-lg cursor-pointer hover:border-indigo-500 transition"
              >
                <div class="text-center">
                  <i
                    class="fas fa-cloud-upload-alt text-3xl text-gray-400 mb-2"
                  ></i>
                  <p class="text-sm text-gray-600">
                    <span class="text-indigo-600 font-semibold"
                      >Klik untuk upload CV</span
                    >
                    atau drag & drop
                  </p>
                  <p class="text-xs text-gray-500 mt-1">PDF (Max 5MB)</p>
                </div>
              </label>
            </div>
            <p id="cv-filename" class="text-sm text-green-600 mt-2 hidden"></p>
          </div>

          <!-- Transkrip Upload -->
          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-2">
              Upload Transkrip Akademik (PDF) <span class="text-red-500">*</span>
            </label>
            <div class="relative">
              <input
                type="file"
                id="candidate-transkrip"
                accept=".pdf"
                required
                class="hidden"
              />
              <label
                for="candidate-transkrip"
                class="flex items-center justify-center w-full px-4 py-3 border-2 border-dashed border-gray-300 rounded-lg cursor-pointer hover:border-indigo-500 transition"
              >
                <div class="text-center">
                  <i
                    class="fas fa-file-pdf text-3xl text-gray-400 mb-2"
                  ></i>
                  <p class="text-sm text-gray-600">
                    <span class="text-indigo-600 font-semibold"
                      >Klik untuk upload Transkrip</span
                    >
                    atau drag & drop
                  </p>
                  <p class="text-xs text-gray-500 mt-1">PDF Transkrip Akademik (Max 5MB)</p>
                </div>
              </label>
            </div>
            <p id="transkrip-filename" class="text-sm text-green-600 mt-2 hidden"></p>
            <div id="transkrip-info" class="mt-2 p-3 bg-blue-50 border border-blue-200 rounded-lg hidden">
              <p class="text-xs font-semibold text-blue-800 mb-1">Informasi Transkrip:</p>
              <div class="text-xs text-blue-700 space-y-1">
                <p id="transkrip-nrp"></p>
                <p id="transkrip-prodi"></p>
                <p id="transkrip-ipk"></p>
                <p id="transkrip-sks"></p>
              </div>
            </div>
          </div>

          <!-- Submit Button -->
          <button
            type="submit"
            class="w-full bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 text-white font-bold py-4 px-6 rounded-xl shadow-lg transform transition hover:scale-105"
          >
            <i class="fas fa-arrow-right mr-2"></i>
            Mulai Interview
          </button>
        </form>
      </div>

      <!-- Interview Section (Hidden initially) -->
      <div id="interview-section" class="hidden">
        <!-- Progress Bar -->
        <div class="bg-white rounded-2xl shadow-xl p-6 mb-6">
          <div class="flex justify-between items-center mb-3">
            <span class="text-sm font-semibold text-gray-700">Progres</span>
            <span
              class="text-sm font-semibold text-indigo-600"
              id="progress-text"
            >
              Pertanyaan 1 dari 4
            </span>
          </div>
          <div class="w-full bg-gray-200 rounded-full h-3">
            <div
              id="progress-bar"
              class="bg-gradient-to-r from-indigo-500 to-purple-600 h-3 rounded-full transition-all duration-500"
              style="width: 25%"
            ></div>
          </div>
        </div>

        <!-- Main Content -->
        <div class="bg-white rounded-2xl shadow-xl overflow-hidden">
          <!-- Video Section -->
          <div class="bg-gradient-to-r from-indigo-600 to-purple-600 p-6">
            <h2 class="text-2xl font-bold text-white mb-4" id="question-title">
              Pertanyaan 1
            </h2>
            <div
              class="relative bg-black rounded-xl overflow-hidden shadow-2xl"
            >
              <video id="question-video" class="w-full" controls>
                <source src="" type="video/mp4" />
                Browser Anda tidak mendukung video.
              </video>
            </div>
          </div>

          <!-- Recording Section -->
          <div class="p-8">
            <div id="recording-section" class="hidden">
              <h3 class="text-xl font-semibold text-gray-800 mb-4">
                <i class="fas fa-microphone text-red-500 mr-2"></i>
                Rekam Jawaban Anda
              </h3>

              <!-- Recording Controls -->
              <div class="flex flex-col items-center gap-4 mb-6">
                <button
                  id="record-btn"
                  class="bg-red-500 hover:bg-red-600 text-white font-bold py-4 px-8 rounded-full shadow-lg transform transition hover:scale-105 flex items-center gap-3"
                >
                  <i class="fas fa-video text-2xl"></i>
                  <span>Mulai Rekam Video</span>
                </button>

                <div id="recording-status" class="hidden">
                  <div
                    class="flex items-center gap-3 text-red-600 font-semibold"
                  >
                    <div
                      class="w-4 h-4 bg-red-600 rounded-full animate-pulse"
                    ></div>
                    <span>Sedang Merekam Video...</span>
                    <span id="record-timer">00:00</span>
                  </div>
                </div>

                <button
                  id="stop-btn"
                  class="hidden bg-gray-700 hover:bg-gray-800 text-white font-bold py-3 px-6 rounded-full shadow-lg transform transition hover:scale-105"
                >
                  <i class="fas fa-stop mr-2"></i>
                  Stop Rekaman
                </button>
              </div>

              <div class="mb-6">
                <video
                  id="live-preview"
                  class="hidden w-full rounded-lg border-2 border-indigo-200"
                  autoplay
                  muted
                  playsinline
                ></video>
              </div>

              <!-- Video Preview -->
              <div id="video-preview" class="hidden mb-6">
                <p class="text-sm text-gray-600 mb-2">Preview Video:</p>
                <video
                  id="preview-video"
                  controls
                  class="w-full rounded-lg border border-gray-200"
                ></video>
              </div>

              <!-- Transcript -->
              <div id="transcript-section" class="hidden mb-6">
                <label class="block text-sm font-semibold text-gray-700 mb-2">
                  Transkripsi:
                </label>
                <div class="bg-gray-50 border-2 border-gray-200 rounded-lg p-4">
                  <p id="transcript-text" class="text-gray-800"></p>
                </div>
              </div>

              <!-- Submit Button -->
              <button
                id="submit-btn"
                class="hidden w-full bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 text-white font-bold py-4 px-6 rounded-xl shadow-lg transform transition hover:scale-105"
              >
                <i class="fas fa-paper-plane mr-2"></i>
                Submit & Lanjut
              </button>

              <!-- Loading -->
              <div id="loading" class="hidden text-center py-4">
                <i class="fas fa-spinner fa-spin text-4xl text-indigo-600"></i>
                <p class="text-gray-600 mt-2">Memproses video...</p>
              </div>
            </div>

            <!-- Video Instructions -->
            <div id="video-instruction" class="text-center py-8">
              <i class="fas fa-play-circle text-6xl text-indigo-600 mb-4"></i>
              <p class="text-gray-600 text-lg">
                Tonton video pertanyaan terlebih dahulu
              </p>
            </div>
          </div>
        </div>
      </div>

      <!-- Completion Screen -->
      <div
        id="completion-screen"
        class="hidden bg-white rounded-2xl shadow-xl p-8"
      >
        <div class="text-center mb-6">
          <i class="fas fa-chart-line text-7xl text-indigo-600 mb-4"></i>
          <h2 class="text-3xl font-bold text-gray-800 mb-2">
            Hasil Analisis Interview
          </h2>
          <p class="text-gray-600 text-lg">
            Berikut rangkuman penilaian otomatis untuk jawaban dan ekspresi
            Anda.
          </p>
        </div>

        <div id="analysis-summary" class="space-y-6">
          <div class="bg-indigo-50 border border-indigo-100 rounded-xl p-5">
            <div class="flex items-center gap-3 mb-3">
              <div class="bg-indigo-600 text-white rounded-full p-3">
                <i class="fas fa-star text-xl"></i>
              </div>
              <div>
                <p class="text-sm text-indigo-700 font-semibold">Skor Akhir</p>
                <p id="final-score" class="text-3xl font-bold text-indigo-800">
                  -
                </p>
              </div>
            </div>
            <p class="text-sm text-indigo-700">
              Skor dihitung berdasarkan kualitas jawaban dan analisis
              komunikasi non-verbal dari keempat video.
            </p>
          </div>

          <div class="grid md:grid-cols-2 gap-4" id="scores-grid"></div>

          <div class="space-y-4" id="analysis-details"></div>
        </div>
      </div>
    </div>

    <script>
      // Konfigurasi Video
      const API_URL = "http://localhost:5000";
      const questions = [
        {
          title: "Pertanyaan 1: Perkenalkan Diri Anda",
          videoUrl: "/videos/q1.mp4",
        },
        {
          title: "Pertanyaan 2: Mengapa tertarik melamar ke PT.XYZ",
          videoUrl: "/videos/q2.mp4",
        },
        {
          title: "Pertanyaan 3: Ceritakan pengalaman Anda",
          videoUrl: "/videos/q3.mp4",
        },
        {
          title: "Pertanyaan 4: Mengapa kami harus menerima Anda",
          videoUrl: "/videos/q4.mp4",
        },
      ];

      let currentQuestion = 0;
      let videoRecorder;
      let audioRecorder;
      let recordedVideoBlob;
      let recordedAudioBlob;
      let recordingStartTime;
      let timerInterval;
      let mediaStream;
      let candidateData = {};

      // Generate unique session ID
      const sessionId =
        "session_" + Date.now() + "_" + Math.random().toString(36).substr(2, 9);

      // Elements
      const registrationForm = document.getElementById("registration-form");
      const interviewSection = document.getElementById("interview-section");
      const candidateForm = document.getElementById("candidate-form");
      const cvInput = document.getElementById("candidate-cv");
      const cvFilename = document.getElementById("cv-filename");
      const transkripInput = document.getElementById("candidate-transkrip");
      const transkripFilename = document.getElementById("transkrip-filename");
      const transkripInfo = document.getElementById("transkrip-info");

      const video = document.getElementById("question-video");
      const recordBtn = document.getElementById("record-btn");
      const stopBtn = document.getElementById("stop-btn");
      const submitBtn = document.getElementById("submit-btn");
      const recordingStatus = document.getElementById("recording-status");
      const livePreview = document.getElementById("live-preview");
      const videoPreview = document.getElementById("video-preview");
      const previewVideo = document.getElementById("preview-video");
      const transcriptSection = document.getElementById("transcript-section");
      const transcriptText = document.getElementById("transcript-text");
      const loading = document.getElementById("loading");
      const recordingSection = document.getElementById("recording-section");
      const videoInstruction = document.getElementById("video-instruction");
      const completionScreen = document.getElementById("completion-screen");
      const analysisDetails = document.getElementById("analysis-details");
      const scoresGrid = document.getElementById("scores-grid");
      const finalScore = document.getElementById("final-score");

      // CV Upload Handler
      cvInput.addEventListener("change", (e) => {
        const file = e.target.files[0];
        if (file) {
          if (file.size > 5 * 1024 * 1024) {
            alert("Ukuran file maksimal 5MB");
            cvInput.value = "";
            cvFilename.classList.add("hidden");
            return;
          }
          cvFilename.textContent = `✓ ${file.name}`;
          cvFilename.classList.remove("hidden");
        }
      });

      // Transkrip Upload Handler
      transkripInput.addEventListener("change", async (e) => {
        const file = e.target.files[0];
        if (file) {
          if (file.size > 5 * 1024 * 1024) {
            alert("Ukuran file transkrip maksimal 5MB");
            transkripInput.value = "";
            transkripFilename.classList.add("hidden");
            transkripInfo.classList.add("hidden");
            return;
          }
          transkripFilename.textContent = `✓ ${file.name}`;
          transkripFilename.classList.remove("hidden");

          // Auto-upload dan parse transkrip
          const formData = new FormData();
          formData.append("transkrip", file);
          formData.append("session_id", sessionId);

          try {
            const response = await fetch(`${API_URL}/upload-transkrip`, {
              method: "POST",
              body: formData,
            });

            const result = await response.json();

            if (result.success) {
              // Tampilkan info transkrip
              document.getElementById("transkrip-nrp").textContent = `NRP: ${result.student_info.NRP || '-'}`;
              document.getElementById("transkrip-prodi").textContent = `Program Studi: ${result.student_info.Program_Studi || '-'}`;
              document.getElementById("transkrip-ipk").textContent = `IPK: ${result.analysis.ipk || 0}`;
              document.getElementById("transkrip-sks").textContent = `Total SKS: ${result.analysis.total_sks || 0} | Total MK: ${result.analysis.total_courses || 0}`;
              transkripInfo.classList.remove("hidden");
            } else {
              alert("Error parsing transkrip: " + result.error);
              transkripInput.value = "";
              transkripFilename.classList.add("hidden");
            }
          } catch (err) {
            console.error("Error upload transkrip:", err);
          }
        }
      });

      // Form Submission
      candidateForm.addEventListener("submit", async (e) => {
        e.preventDefault();

        // Validasi transkrip sudah diupload
        if (!transkripInput.files[0]) {
          alert("Mohon upload transkrip akademik terlebih dahulu!");
          return;
        }

        // Validasi transkrip sudah berhasil di-parse (info muncul)
        if (transkripInfo.classList.contains("hidden")) {
          alert("Transkrip masih dalam proses parsing. Mohon tunggu sebentar.");
          return;
        }

        candidateData = {
          name: document.getElementById("candidate-name").value,
          email: document.getElementById("candidate-email").value,
          position: document.getElementById("candidate-position").value,
          cv_file: cvInput.files[0],
          transkrip_file: transkripInput.files[0],
        };

        // Upload CV first
        const formData = new FormData();
        formData.append("cv", candidateData.cv_file);
        formData.append("session_id", sessionId);
        formData.append("name", candidateData.name);
        formData.append("email", candidateData.email);
        formData.append("position", candidateData.position);

        try {
          const response = await fetch(`${API_URL}/upload-cv`, {
            method: "POST",
            body: formData,
          });

          const result = await response.json();

          if (result.success) {
            candidateData.cv_filename = result.cv_filename;

            // Hide form, show interview
            registrationForm.classList.add("hidden");
            interviewSection.classList.remove("hidden");
            loadQuestion();
          } else {
            alert("Error upload CV: " + result.error);
          }
        } catch (err) {
          alert("Error: " + err.message);
        }
      });

      // Load question
      function loadQuestion() {
        if (currentQuestion >= questions.length) {
          showCompletion();
          return;
        }

        const q = questions[currentQuestion];
        document.getElementById("question-title").textContent = q.title;
        video.src = q.videoUrl;

        // Update progress
        const progress = ((currentQuestion + 1) / questions.length) * 100;
        document.getElementById("progress-bar").style.width = progress + "%";
        document.getElementById("progress-text").textContent = `Pertanyaan ${
          currentQuestion + 1
        } dari ${questions.length}`;

        // Reset UI
        recordingSection.classList.add("hidden");
        videoInstruction.classList.remove("hidden");
        if (livePreview.srcObject) {
          livePreview.srcObject.getTracks().forEach((track) => track.stop());
          livePreview.srcObject = null;
        }
        livePreview.classList.add("hidden");
        videoPreview.classList.add("hidden");
        recordedVideoBlob = null;
        recordedAudioBlob = null;
        mediaStream = null;
        transcriptSection.classList.add("hidden");
        submitBtn.classList.add("hidden");
        recordBtn.classList.remove("hidden");
        stopBtn.classList.add("hidden");
        recordingStatus.classList.add("hidden");
      }

      // Video ended handler
      video.addEventListener("ended", () => {
        videoInstruction.classList.add("hidden");
        recordingSection.classList.remove("hidden");
      });

      // Start recording dengan RecordRTC (Video + Audio)
      recordBtn.addEventListener("click", async () => {
        try {
          const stream = await navigator.mediaDevices.getUserMedia({
            audio: {
              sampleRate: 16000,
              channelCount: 1,
              echoCancellation: true,
              noiseSuppression: true,
            },
            video: {
              facingMode: "user",
              width: { ideal: 1280 },
              height: { ideal: 720 },
            },
          });

          mediaStream = stream;
          livePreview.srcObject = stream;
          livePreview.classList.remove("hidden");
          livePreview.play();

          videoRecorder = RecordRTC(stream, {
            type: "video",
            mimeType: "video/webm;codecs=vp9",
            disableLogs: true,
          });

          audioRecorder = RecordRTC(stream, {
            type: "audio",
            mimeType: "audio/wav",
            recorderType: RecordRTC.StereoAudioRecorder,
            numberOfAudioChannels: 1,
            desiredSampRate: 16000,
          });

          videoRecorder.startRecording();
          audioRecorder.startRecording();
          recordBtn.classList.add("hidden");
          stopBtn.classList.remove("hidden");
          recordingStatus.classList.remove("hidden");

          recordingStartTime = Date.now();
          timerInterval = setInterval(updateTimer, 1000);
        } catch (err) {
          alert("Error mengakses kamera/mikrofon: " + err.message);
        }
      });

      // Stop recording
      stopBtn.addEventListener("click", async () => {
        if (!videoRecorder || !audioRecorder) return;

        stopBtn.disabled = true;

        const stopVideo = new Promise((resolve) => {
          videoRecorder.stopRecording(() => resolve(videoRecorder.getBlob()));
        });

        const stopAudio = new Promise((resolve) => {
          audioRecorder.stopRecording(() => resolve(audioRecorder.getBlob()));
        });

        const [videoBlob, audioBlob] = await Promise.all([
          stopVideo,
          stopAudio,
        ]);

        recordedVideoBlob = videoBlob;
        recordedAudioBlob = audioBlob;

        previewVideo.src = URL.createObjectURL(recordedVideoBlob);
        previewVideo.load();
        videoPreview.classList.remove("hidden");
        submitBtn.classList.remove("hidden");

        videoRecorder.destroy();
        audioRecorder.destroy();
        videoRecorder = null;
        audioRecorder = null;

        if (mediaStream) {
          mediaStream.getTracks().forEach((track) => track.stop());
          mediaStream = null;
        }

        if (livePreview.srcObject) {
          livePreview.srcObject.getTracks().forEach((track) => track.stop());
          livePreview.srcObject = null;
        }

        livePreview.classList.add("hidden");

        stopBtn.disabled = false;
        stopBtn.classList.add("hidden");
        recordBtn.classList.remove("hidden");
        recordingStatus.classList.add("hidden");
        clearInterval(timerInterval);
      });

      // Update timer
      function updateTimer() {
        const elapsed = Math.floor((Date.now() - recordingStartTime) / 1000);
        const mins = Math.floor(elapsed / 60)
          .toString()
          .padStart(2, "0");
        const secs = (elapsed % 60).toString().padStart(2, "0");
        document.getElementById("record-timer").textContent = `${mins}:${secs}`;
      }

      // Submit answer
      submitBtn.addEventListener("click", async () => {
        if (!recordedVideoBlob || !recordedAudioBlob) {
          alert("Silakan rekam jawaban video terlebih dahulu.");
          return;
        }
        loading.classList.remove("hidden");
        submitBtn.classList.add("hidden");

        const formData = new FormData();
        formData.append(
          "video",
          recordedVideoBlob,
          `answer_q${currentQuestion + 1}.webm`
        );
        formData.append(
          "audio",
          recordedAudioBlob,
          `answer_q${currentQuestion + 1}.wav`
        );
        formData.append("question_number", currentQuestion + 1);
        formData.append("session_id", sessionId);

        try {
          const response = await fetch(`${API_URL}/transcribe`, {
            method: "POST",
            body: formData,
          });

          const result = await response.json();

          if (result.success) {
            transcriptText.textContent = result.transcript;
            transcriptSection.classList.remove("hidden");

            if (
              result.is_last_question &&
              result.webhook_status === "success"
            ) {
              currentQuestion++;
              showCompletion(result.webhook_result);
              return;
            }

            setTimeout(() => {
              currentQuestion++;
              loadQuestion();
            }, 2000);
          } else {
            alert("Error: " + result.error);
            submitBtn.classList.remove("hidden");
          }
        } catch (err) {
          alert("Error mengirim data: " + err.message);
          submitBtn.classList.remove("hidden");
        } finally {
          loading.classList.add("hidden");
        }
      });

      // Show completion
      function showCompletion(webhookResult) {
        interviewSection.classList.add("hidden");
        completionScreen.classList.remove("hidden");

        // Reset konten sebelumnya
        analysisDetails.innerHTML = "";
        scoresGrid.innerHTML = "";
        finalScore.textContent = "-";

        if (!webhookResult) {
          const emptyState = document.createElement("div");
          emptyState.className =
            "bg-yellow-50 border border-yellow-200 text-yellow-800 rounded-xl p-4";
          emptyState.innerHTML =
            "<strong>Catatan:</strong> Hasil analisis belum tersedia dari webhook.";
          analysisDetails.appendChild(emptyState);
          return;
        }

        // Tampilkan skor akhir
        if (webhookResult.skor_final !== undefined) {
          finalScore.textContent = webhookResult.skor_final;
        }

        const scoreMapping = [
          { key: "skor1", label: "Skor Jawaban 1" },
          { key: "skor2", label: "Skor Jawaban 2" },
          { key: "skor3", label: "Skor Jawaban 3" },
          { key: "skor4", label: "Skor Jawaban 4" },
        ];

        scoreMapping.forEach((item) => {
          const value = webhookResult[item.key];
          if (value === undefined) return;

          const card = document.createElement("div");
          card.className =
            "border border-gray-200 rounded-xl p-4 flex items-center gap-3";
          card.innerHTML = `
            <div class="bg-indigo-100 text-indigo-700 rounded-full h-12 w-12 flex items-center justify-center font-bold">
              ${item.key.replace("skor", "Q")}
            </div>
            <div>
              <p class="text-sm text-gray-500">${item.label}</p>
              <p class="text-2xl font-bold text-gray-800">${value}</p>
            </div>
          `;
          scoresGrid.appendChild(card);
        });

        const analysisMapping = [
          { key: "analisis_jawaban1", title: "Analisis Jawaban 1" },
          { key: "analisis_jawaban2", title: "Analisis Jawaban 2" },
          { key: "analisis_jawaban3", title: "Analisis Jawaban 3" },
          { key: "analisis_jawaban4", title: "Analisis Jawaban 4" },
          { key: "analisis_video1", title: "Analisis Video 1" },
          { key: "analisis_video2", title: "Analisis Video 2" },
          { key: "analisis_video3", title: "Analisis Video 3" },
          { key: "analisis_video4", title: "Analisis Video 4" },
        ];

        analysisMapping.forEach((item) => {
          const text = webhookResult[item.key];
          if (!text) return;

          const card = document.createElement("div");
          card.className = "border border-gray-200 rounded-xl p-5";
          card.innerHTML = `
            <div class="flex items-center justify-between mb-3">
              <h3 class="text-lg font-semibold text-gray-800">${item.title}</h3>
              <i class="fas fa-info-circle text-indigo-500"></i>
            </div>
            <p class="text-gray-700 whitespace-pre-line">${text}</p>
          `;
          analysisDetails.appendChild(card);
        });
      }

      // Reset session and reload
      async function resetAndReload() {
        try {
          await fetch(`${API_URL}/reset-session`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ session_id: sessionId }),
          });
        } catch (err) {
          console.error("Error resetting session:", err);
        }
        location.reload();
      }
    </script>
  </body>
</html>
