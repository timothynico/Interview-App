<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Review Kandidat - Dashboard</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
      }

      .container {
        max-width: 1400px;
        margin: 0 auto;
        background: white;
        border-radius: 15px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        overflow: hidden;
      }

      .header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 30px;
        text-align: center;
      }

      .header h1 {
        font-size: 2.5em;
        margin-bottom: 10px;
      }

      .header p {
        opacity: 0.9;
        font-size: 1.1em;
      }

      .table-container {
        padding: 30px;
        overflow-x: auto;
      }

      .table-controls {
        display: flex;
        gap: 20px;
        margin-bottom: 15px;
        flex-wrap: wrap;
        align-items: flex-end;
      }

      .control-group {
        display: flex;
        flex-direction: column;
        gap: 6px;
      }

      .control-group label {
        font-weight: 600;
        color: #4a4a4a;
      }

      .control-group select {
        padding: 10px 14px;
        border-radius: 8px;
        border: 1px solid #d0d0d0;
        font-size: 0.95em;
        min-width: 200px;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        background: white;
      }

      thead {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
      }

      th {
        padding: 15px;
        text-align: left;
        font-weight: 600;
        text-transform: uppercase;
        font-size: 0.9em;
        letter-spacing: 0.5px;
      }

      td {
        padding: 15px;
        border-bottom: 1px solid #e0e0e0;
      }

      tbody tr {
        transition: background-color 0.3s;
      }

      tbody tr:hover {
        background-color: #f5f5f5;
      }

      .actions {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
      }

      .btn {
        padding: 8px 16px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 0.9em;
        font-weight: 500;
        transition: all 0.3s;
        display: inline-flex;
        align-items: center;
        gap: 5px;
      }

      .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      }

      .btn-cv {
        background: #4caf50;
        color: white;
      }

      .btn-cv:hover {
        background: #45a049;
      }

      .btn-answers {
        background: #2196f3;
        color: white;
      }

      .btn-answers:hover {
        background: #0b7dda;
      }

      .btn-chat {
        background: #ff9800;
        color: white;
      }

      .btn-chat:hover {
        background: #e68900;
      }

      /* Modal Styles */
      .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.6);
        animation: fadeIn 0.3s;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }

      .modal-content {
        background-color: white;
        margin: 5% auto;
        padding: 0;
        border-radius: 15px;
        width: 90%;
        max-width: 800px;
        max-height: 80vh;
        overflow: hidden;
        animation: slideDown 0.3s;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
      }

      @keyframes slideDown {
        from {
          transform: translateY(-50px);
          opacity: 0;
        }
        to {
          transform: translateY(0);
          opacity: 1;
        }
      }

      .modal-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 20px 30px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .modal-header h2 {
        margin: 0;
        font-size: 1.5em;
      }

      .close {
        color: white;
        font-size: 35px;
        font-weight: bold;
        cursor: pointer;
        line-height: 1;
        transition: transform 0.3s;
      }

      .close:hover {
        transform: rotate(90deg);
      }

      .modal-body {
        padding: 30px;
        max-height: 60vh;
        overflow-y: auto;
      }

      .cv-text {
        white-space: pre-wrap;
        line-height: 1.8;
        color: #333;
        font-size: 0.95em;
      }

      .answer-item {
        background: #f8f9fa;
        padding: 20px;
        margin-bottom: 15px;
        border-radius: 10px;
        border-left: 4px solid #667eea;
      }

      .answer-item h4 {
        color: #667eea;
        margin-bottom: 10px;
        font-size: 1.1em;
      }

      .answer-item p {
        color: #555;
        line-height: 1.6;
      }

      /* Chat Styles */
      .chat-container {
        display: flex;
        flex-direction: column;
        height: 60vh;
      }

      .chat-tabs {
        display: flex;
        gap: 10px;
        margin-bottom: 12px;
      }

      .chat-tab {
        padding: 10px 16px;
        border-radius: 20px;
        border: 2px solid transparent;
        background: #f1f3f5;
        color: #555;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
      }

      .chat-tab.active {
        background: #667eea;
        color: #fff;
        border-color: #5568d3;
        box-shadow: 0 6px 16px rgba(102, 126, 234, 0.35);
      }

      .chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
        background: #f8f9fa;
        border-radius: 10px;
        margin-bottom: 15px;
      }

      .message {
        margin-bottom: 15px;
        display: flex;
        align-items: flex-start;
        gap: 10px;
      }

      .message.user {
        flex-direction: row-reverse;
      }

      .message-content {
        max-width: 70%;
        padding: 12px 18px;
        border-radius: 15px;
        line-height: 1.5;
      }

      .message.ai .message-content {
        background: #667eea;
        color: white;
        border-bottom-left-radius: 5px;
      }

      .message.user .message-content {
        background: #e0e0e0;
        color: #333;
        border-bottom-right-radius: 5px;
      }

      .chat-input-container {
        display: flex;
        gap: 10px;
      }

      .chat-input {
        flex: 1;
        padding: 12px 18px;
        border: 2px solid #e0e0e0;
        border-radius: 25px;
        font-size: 1em;
        outline: none;
        transition: border-color 0.3s;
      }

      .chat-input:focus {
        border-color: #667eea;
      }

      .btn-send {
        padding: 12px 30px;
        background: #667eea;
        color: white;
        border: none;
        border-radius: 25px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s;
      }

      .btn-send:hover {
        background: #5568d3;
        transform: scale(1.05);
      }

      .status-badge {
        display: inline-block;
        padding: 5px 12px;
        border-radius: 20px;
        font-size: 0.85em;
        font-weight: 600;
      }

      .status-complete {
        background: #d4edda;
        color: #155724;
      }

      .status-pending {
        background: #fff3cd;
        color: #856404;
      }

      .status-accepted {
        background: #e0f7ef;
        color: #0f5132;
      }

      .status-rejected {
        background: #fde2e1;
        color: #842029;
      }

      .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: #999;
      }

      .empty-state svg {
        width: 100px;
        height: 100px;
        margin-bottom: 20px;
        opacity: 0.3;
      }

      .loading {
        text-align: center;
        padding: 40px;
        color: #667eea;
        font-size: 1.2em;
      }

      .answer-meta {
        margin-top: 12px;
        display: grid;
        gap: 8px;
      }

      .answer-meta p {
        margin: 0;
        color: #444;
      }

      .rating-input {
        margin-top: 12px;
        display: flex;
        gap: 10px;
        align-items: center;
        flex-wrap: wrap;
      }

      .rating-input input {
        padding: 8px 10px;
        border-radius: 6px;
        border: 1px solid #d0d0d0;
        width: 120px;
      }

      .rating-input button {
        background: #667eea;
        color: white;
        border: none;
        padding: 8px 14px;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.2s ease;
      }

      .rating-input button:hover {
        background: #5568d3;
        transform: translateY(-1px);
      }

      .rating-feedback {
        color: #444;
        font-size: 0.9em;
      }

      @media (max-width: 768px) {
        .actions {
          flex-direction: column;
        }

        .btn {
          width: 100%;
          justify-content: center;
        }

        .modal-content {
          width: 95%;
          margin: 10% auto;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>üìã Review Kandidat</h1>
        <p>Dashboard untuk mengelola dan meninjau semua kandidat</p>
      </div>

      <div class="table-container">
        <div class="table-controls">
          <div class="control-group">
            <label for="statusFilter">Filter Status</label>
            <select id="statusFilter" onchange="applyFilters()">
              <option value="all">Semua Status</option>
              <option value="diterima">Diterima</option>
              <option value="ditolak">Ditolak</option>
              <option value="pending">Belum Diputuskan</option>
            </select>
          </div>
          <div class="control-group">
            <label for="scoreSort">Urutkan Skor</label>
            <select id="scoreSort" onchange="applyFilters()">
              <option value="none">Tanpa Pengurutan</option>
              <option value="score-desc">Skor Tertinggi</option>
              <option value="score-asc">Skor Terendah</option>
            </select>
          </div>
        </div>
        <table id="candidateTable">
          <thead>
            <tr>
              <th>Nama</th>
              <th>Email</th>
              <th>Posisi</th>
              <th>Status</th>
              <th>Skor</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="candidateBody">
            <tr>
              <td colspan="6">
                <div class="loading">Loading data...</div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Modal Review CV -->
    <div id="cvModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2>üìÑ Review CV</h2>
          <span class="close" onclick="closeModal('cvModal')">&times;</span>
        </div>
        <div class="modal-body">
          <h3
            id="cvCandidateName"
            style="margin-bottom: 20px; color: #667eea"
          ></h3>
          <div id="cvContent" class="cv-text"></div>
        </div>
      </div>
    </div>

    <!-- Modal Review Jawaban -->
    <div id="answersModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2>üí¨ Review Jawaban Interview</h2>
          <span class="close" onclick="closeModal('answersModal')"
            >&times;</span
          >
        </div>
        <div class="modal-body">
          <h3
            id="answersCandidateName"
            style="margin-bottom: 20px; color: #667eea"
          ></h3>
          <div id="answersContent"></div>
        </div>
      </div>
    </div>

    <!-- Modal Chat AI -->
    <div id="chatModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2>ü§ñ Chat dengan AI</h2>
          <span class="close" onclicRk="closeModal('chatModal')">&times;</span>
        </div>
        <div class="modal-body">
          <h3
            id="chatCandidateName"
            style="margin-bottom: 20px; color: #667eea"
          ></h3>
          <div class="chat-container">
            <div class="chat-tabs" id="chatTabs"></div>
            <div class="chat-messages" id="chatMessages"></div>
            <div class="chat-input-container">
              <input
                type="text"
                class="chat-input"
                id="chatInput"
                placeholder="Ketik pertanyaan Anda..."
              />
              <button class="btn-send" onclick="sendMessage()">Kirim</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      const API_BASE_URL = "http://localhost:5000";
      const RATING_WEBHOOK_URL =
        "https://n8n-1.saturn.petra.ac.id/webhook-test/aec84aa6-343c-4e79-810c-cd6f70701030";
      let currentSessionId = null;
      let cur_user_id = null;
      let allCandidates = [];
      const chatCandidates = {};
      const CHAT_ENDPOINTS = {
        interview: `${API_BASE_URL}/api/chat/interview`,
        transkrip: `${API_BASE_URL}/api/chat/transkrip`,
        skkk: `${API_BASE_URL}/api/chat/skkk`,
      };

      const CHAT_ROOMS = [
        { id: "interview", label: "Chat Hasil Interview" },
        { id: "transkrip", label: "Chat Transkrip" },
        { id: "skkk", label: "Chat SKKK" },
      ];

      let activeChatRoom = "interview";
      const chatHistories = {};

      // Pertanyaan interview
      const questions = [
        "Halo, perkenalkan saya Lesti, AI HRD dari PT XYZ. Silakan memperkenalkan diri Anda.",
        "Baik, pertanyaan selanjutnya, Kenapa Anda tertarik melamar di perusahaan kami?",
        "Ceritakan pengalaman Anda yang relevan dengan posisi yang Anda lamar",
        "Pertanyaan terakhir, mengapa kami harus menerima anda untuk bergabung di perusahaan kami?",
      ];

      function defaultAiGreeting(roomId, candidateName) {
        switch (roomId) {
          case "interview":
            return `Halo! Saya bisa membantu meninjau jawaban interview ${candidateName}. Apa yang ingin Anda dalami?`;
          case "transkrip":
            return `Halo! Saya bisa membantu menganalisis transkrip akademik ${candidateName}. Ada yang ingin Anda tanyakan?`;
          case "skkk":
            return `Halo! Saya siap membantu meninjau data SKKK ${candidateName}. Mau mulai dari aktivitas apa?`;
          default:
            return `Halo! Saya AI assistant. Saya siap membantu Anda menganalisis kandidat ${candidateName}. Apa yang ingin Anda ketahui?`;
        }
      }

      function getRoomLabel(roomId) {
        const room = CHAT_ROOMS.find((r) => r.id === roomId);
        return room ? room.label : roomId;
      }

      function ensureChatSession(sessionId, candidateName) {
        if (!chatHistories[sessionId]) {
          chatHistories[sessionId] = {};
        }

        CHAT_ROOMS.forEach(({ id }) => {
          if (!chatHistories[sessionId][id]) {
            chatHistories[sessionId][id] = [
              { sender: "ai", text: defaultAiGreeting(id, candidateName) },
            ];
          }
        });
      }

      function renderChatTabs() {
        const chatTabs = document.getElementById("chatTabs");
        chatTabs.innerHTML = CHAT_ROOMS.map(
          ({ id, label }) => `
              <button class="chat-tab ${id === activeChatRoom ? "active" : ""}" onclick="setActiveChatRoom('${id}')">
                ${label}
              </button>
            `
        ).join("");
      }

      function renderChatMessages() {
        const chatMessages = document.getElementById("chatMessages");
        const sessionHistory = chatHistories[currentSessionId] || {};
        const roomHistory = sessionHistory[activeChatRoom] || [];

        chatMessages.innerHTML = roomHistory
          .map(
            (entry) => `
              <div class="message ${entry.sender}">
                <div class="message-content">${escapeHtml(entry.text)}</div>
              </div>
            `
          )
          .join("");

        chatMessages.scrollTop = chatMessages.scrollHeight;
      }

      function setActiveChatRoom(roomId) {
        activeChatRoom = roomId;
        renderChatTabs();
        renderChatMessages();
        updateChatPlaceholder();
      }

      function updateChatPlaceholder() {
        const chatInput = document.getElementById("chatInput");
        if (!chatInput) return;
        chatInput.placeholder = `Ketik pertanyaan untuk ${getRoomLabel(
          activeChatRoom
        )}...`;
      }

      function addTypingIndicator() {
        const chatMessages = document.getElementById("chatMessages");
        const indicator = document.createElement("div");
        indicator.className = "message ai";
        indicator.id = "typingIndicator";
        indicator.innerHTML = `<div class="message-content">AI sedang memproses (${getRoomLabel(
          activeChatRoom
        )})...</div>`;
        chatMessages.appendChild(indicator);
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }

      function removeTypingIndicator() {
        const typingIndicator = document.getElementById("typingIndicator");
        if (typingIndicator) {
          typingIndicator.remove();
        }
      }

      // Load kandidat dari API
      async function loadCandidates() {
        try {
          const response = await fetch(`${API_BASE_URL}/api/candidates`);
          const data = await response.json();

          if (data.success && data.candidates) {
            allCandidates = data.candidates;
            console.log('allCandidates', allCandidates);
            applyFilters();
          } else {
            showEmptyState();
          }
        } catch (error) {
          console.error("Error loading candidates:", error);
          showErrorState();
        }
      }

      // Render kandidat ke tabel
      function renderCandidates(candidates) {
        const tbody = document.getElementById("candidateBody");

        if (candidates.length === 0) {
          showEmptyState();
          return;
        }

        tbody.innerHTML = candidates
          .map((candidate) => {
            const statusInfo = getStatusInfo(candidate.is_terima);
            const scoreDisplay = formatScore(candidate.skor_final);
            return `
                    <tr>
                        <td><strong>${candidate.nama}</strong></td>
                        <td>${candidate.email}</td>
                        <td>${candidate.posisi_dilamar}</td>
                        <td><span class="status-badge ${statusInfo.className}">${statusInfo.label}</span></td>
                        <td>${scoreDisplay}</td>
                        <td>
                            <div class="actions">
                                <button class="btn btn-cv" onclick="showCV('${candidate.session_id}')">
                                    üìÑ CV
                                </button>
                                <button class="btn btn-answers" onclick="showAnswers('${candidate.session_id}')">
                                    üí¨ Jawaban
                                </button>
                                <button class="btn btn-chat" onclick="showChat('${candidate.session_id}', '${candidate.id}')">
                                    ü§ñ Chat AI
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
          })
          .join("");
      }

      // Tampilkan empty state
      function showEmptyState() {
        const tbody = document.getElementById("candidateBody");
        tbody.innerHTML = `
                <tr>
                    <td colspan="6">
                        <div class="empty-state">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"></path>
                            </svg>
                            <h3>Belum ada kandidat</h3>
                            <p>Data kandidat akan muncul di sini setelah mereka menyelesaikan interview</p>
                        </div>
                    </td>
                </tr>
            `;
      }

      // Tampilkan error state
      function showErrorState() {
        const tbody = document.getElementById("candidateBody");
        tbody.innerHTML = `
                <tr>
                    <td colspan="6">
                        <div class="empty-state">
                            <h3 style="color: #dc3545;">‚ùå Gagal memuat data</h3>
                            <p>Terjadi kesalahan saat memuat data kandidat. Silakan refresh halaman.</p>
                        </div>
                    </td>
                </tr>
            `;
      }

      // Fungsi untuk menampilkan CV
      function showCV(sessionId) {
        const candidate = allCandidates.find((c) => c.session_id === sessionId);
        if (!candidate) return;

        document.getElementById(
          "cvCandidateName"
        ).textContent = `CV - ${candidate.nama}`;
        document.getElementById("cvContent").textContent =
          candidate.CV || "CV tidak tersedia";
        document.getElementById("cvModal").style.display = "block";
      }

      // Fungsi untuk menampilkan jawaban
      function showAnswers(sessionId) {
        const candidate = allCandidates.find((c) => c.session_id === sessionId);
        if (!candidate) return;

        document.getElementById(
          "answersCandidateName"
        ).textContent = `Jawaban Interview - ${candidate.nama}`;

        const answersHTML = questions
          .map((question, index) => {
            const qKey = `Q${index + 1}`;
            const answerData =
              (candidate.answers || []).find(
                (ans) => ans.question_number === index + 1
              ) || {};
            const answer = answerData.content || candidate[qKey] || "Tidak ada jawaban";
            const analisisJawaban =
              answerData.analisis_jawaban || "Tidak ada analisis jawaban";
            const analisisVideo =
              answerData.analisis_video || "Tidak ada analisis video";
            const skorPertanyaan =
              answerData.skor_pertanyaan !== undefined && answerData.skor_pertanyaan !== null
                ? answerData.skor_pertanyaan
                : "-";
            const skorVideo =
              answerData.skor_video !== undefined && answerData.skor_video !== null
                ? answerData.skor_video
                : "-";
            const humanRating =
              answerData.human_rating !== undefined && answerData.human_rating !== null
                ? answerData.human_rating
                : "-";
            const documentId = answerData.id;
            const inputId = `rating-input-${documentId || index}`;
            const feedbackId = `rating-feedback-${documentId || index}`;

            return `
                    <div class="answer-item">
                        <h4>Pertanyaan ${index + 1}: ${question}</h4>
                        <p>${answer}</p>
                        <div class="answer-meta">
                          <p><strong>Analisis Jawaban:</strong> ${analisisJawaban}</p>
                          <p><strong>Skor Pertanyaan:</strong> ${skorPertanyaan}</p>
                          <p><strong>Analisis Video:</strong> ${analisisVideo}</p>
                          <p><strong>Skor Video:</strong> ${skorVideo}</p>
                          <p><strong>Human Rating:</strong> ${humanRating}</p>
                          <div class="rating-input">
                            <label for="${inputId}"><strong>Nilai Baru:</strong></label>
                            <input type="number" id="${inputId}" min="0" max="100" placeholder="0-100" ${
              documentId ? "" : "disabled"
            } />
                            <button onclick="submitHumanRating('${documentId}', '${inputId}', '${feedbackId}')" ${
              documentId ? "" : "disabled"
            }>Kirim Nilai</button>
                            <span id="${feedbackId}" class="rating-feedback"></span>
                          </div>
                          ${
                            documentId
                              ? ""
                              : "<p style='color:#c00;font-size:0.9em;'>ID dokumen tidak ditemukan, tidak bisa mengirim nilai.</p>"
                          }
                        </div>
                    </div>
                `;
          })
          .join("");

        document.getElementById("answersContent").innerHTML = answersHTML;
        document.getElementById("answersModal").style.display = "block";
      }

      async function submitHumanRating(documentId, inputId, feedbackId) {
        const feedbackEl = document.getElementById(feedbackId);
        const inputEl = document.getElementById(inputId);

        if (!documentId) {
          if (feedbackEl) {
            feedbackEl.textContent = "ID dokumen tidak tersedia.";
            feedbackEl.style.color = "#c00";
          }
          return;
        }

        const nilai = Number(inputEl?.value);
        if (Number.isNaN(nilai) || nilai < 0 || nilai > 100) {
          if (feedbackEl) {
            feedbackEl.textContent = "Masukkan nilai antara 0 - 100.";
            feedbackEl.style.color = "#c00";
          }
          return;
        }

        if (feedbackEl) {
          feedbackEl.textContent = "Mengirim...";
          feedbackEl.style.color = "#444";
        }

        try {
          const response = await fetch(RATING_WEBHOOK_URL, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ id: documentId, nilai }),
          });

          if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
          }

          if (feedbackEl) {
            feedbackEl.textContent = "Nilai berhasil dikirim.";
            feedbackEl.style.color = "#0f5132";
          }
        } catch (error) {
          console.error("Gagal mengirim nilai:", error);
          if (feedbackEl) {
            feedbackEl.textContent = "Gagal mengirim nilai. Coba lagi.";
            feedbackEl.style.color = "#c00";
          }
        }
      }

      // Fungsi untuk menampilkan chat
      function showChat(sessionId, user_id) {
        currentSessionId = sessionId;
        cur_user_id = user_id;

        const candidate = allCandidates.find((c) => c.session_id === sessionId);
        if (!candidate) return;
        const candidateNRP =
          candidate.transkrip_nrp ||
          candidate.nrp ||
          candidate.NRP ||
          candidate.transkrip?.nrp ||
          null;

        document.getElementById(
          "chatCandidateName"
        ).textContent = `Chat AI - ${candidate.nama}`;

        chatCandidates[sessionId] = {
          name: candidate.nama,
          nrp: candidateNRP,
        };
        ensureChatSession(sessionId, candidate.nama);
        activeChatRoom = "interview";
        renderChatTabs();
        renderChatMessages();
        updateChatPlaceholder();
        document.getElementById("chatModal").style.display = "block";
        document.getElementById("chatInput").value = "";
        document.getElementById("chatInput").focus();
      }

      // Fungsi untuk mengirim pesan
      async function sendMessage() {
        const input = document.getElementById("chatInput");
        const message = input.value.trim();

        if (!message || !currentSessionId) return;

        ensureChatSession(currentSessionId, chatCandidates[currentSessionId]);
        const roomHistory = chatHistories[currentSessionId][activeChatRoom];
        roomHistory.push({ sender: "user", text: message });
        renderChatMessages();

        input.value = "";
        addTypingIndicator();

        try {
          const endpoint =
            CHAT_ENDPOINTS[activeChatRoom] || `${API_BASE_URL}/api/chat`;
          // Kirim ke API backend yang akan forward ke n8n untuk RAG processing
          const response = await fetch(endpoint, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              session_id: cur_user_id, // Ini akan jadi user_id di n8n
              message: message,
              chat_room: activeChatRoom,
              candidate_session: currentSessionId,
              nrp: chatCandidates[currentSessionId]?.nrp || null,
            }),
          });

          console.log(response);

          const data = await response.json();
          removeTypingIndicator();

          // Tambahkan respons AI dari n8n
          if (data.success && data.response) {
            roomHistory.push({ sender: "ai", text: data.response });
          } else {
            // Tampilkan error jika gagal
            roomHistory.push({
              sender: "ai",
              text: `Maaf, terjadi kesalahan: ${data.error || "Unknown error"}`,
            });
          }
        } catch (error) {
          console.error("Error sending message:", error);
          removeTypingIndicator();

          // Tampilkan error message
          roomHistory.push({
            sender: "ai",
            text: "Maaf, tidak dapat terhubung ke server. Silakan coba lagi.",
          });
        }

        renderChatMessages();
      }

      // Helper function untuk escape HTML
      function escapeHtml(text) {
        const map = {
          "&": "&amp;",
          "<": "&lt;",
          ">": "&gt;",
          '"': "&quot;",
          "'": "&#039;",
        };
        return text.replace(/[&<>"']/g, (m) => map[m]);
      }

      // Fungsi untuk menutup modal
      function closeModal(modalId) {
        document.getElementById(modalId).style.display = "none";
        if (modalId === "chatModal") {
          currentSessionId = null;
        }
      }

      // Event listener untuk Enter key di chat
      document.addEventListener("DOMContentLoaded", function () {
        const chatInput = document.getElementById("chatInput");
        if (chatInput) {
          chatInput.addEventListener("keypress", function (e) {
            if (e.key === "Enter") {
              sendMessage();
            }
          });
        }

        // Load kandidat saat halaman dimuat
        loadCandidates();

        // Refresh data setiap 30 detik (untuk live update dari Supabase nanti)
        setInterval(loadCandidates, 30000);
      });

      // Close modal when clicking outside
      window.onclick = function (event) {
        if (event.target.classList.contains("modal")) {
          event.target.style.display = "none";
          if (event.target.id === "chatModal") {
            currentSessionId = null;
          }
        }
      };

      function getStatusValue(isAccepted) {
        if (isAccepted === true) return "diterima";
        if (isAccepted === false) return "ditolak";
        return "pending";
      }

      function getStatusInfo(isAccepted) {
        const statusValue = getStatusValue(isAccepted);
        if (statusValue === "diterima") {
          return { label: "Diterima", className: "status-accepted" };
        }
        if (statusValue === "ditolak") {
          return { label: "Ditolak", className: "status-rejected" };
        }
        return { label: "Diproses", className: "status-pending" };
      }

      function formatScore(score) {
        if (score === null || score === undefined || score === "") return "-";
        const numericScore = Number(score);
        if (Number.isNaN(numericScore)) return "-";
        return numericScore % 1 === 0 ? numericScore : numericScore.toFixed(2);
      }

      function getSortableScore(candidate) {
        const numericScore = Number(candidate.skor_final);
        return Number.isNaN(numericScore) ? null : numericScore;
      }

      function applyFilters() {
        let filtered = [...allCandidates];
        const statusFilter = document.getElementById("statusFilter")?.value || "all";
        const scoreSort = document.getElementById("scoreSort")?.value || "none";

        if (statusFilter !== "all") {
          filtered = filtered.filter(
            (candidate) => getStatusValue(candidate.is_terima) === statusFilter
          );
        }

        if (scoreSort === "score-asc") {
          filtered.sort((a, b) => {
            const scoreA = getSortableScore(a);
            const scoreB = getSortableScore(b);
            if (scoreA === null && scoreB === null) return 0;
            if (scoreA === null) return 1;
            if (scoreB === null) return -1;
            return scoreA - scoreB;
          });
        }

        if (scoreSort === "score-desc") {
          filtered.sort((a, b) => {
            const scoreA = getSortableScore(a);
            const scoreB = getSortableScore(b);
            if (scoreA === null && scoreB === null) return 0;
            if (scoreA === null) return 1;
            if (scoreB === null) return -1;
            return scoreB - scoreA;
          });
        }

        renderCandidates(filtered);
      }
    </script>
  </body>
</html>
